# è‡ªåŠ¨æ•°æ®åº“è¿ç§»

## æ¦‚è¿°

é¡¹ç›®åœ¨ Docker å®¹å™¨å¯åŠ¨æ—¶ä¼š**è‡ªåŠ¨æ‰§è¡Œæ•°æ®åº“è¿ç§»**ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

## å·¥ä½œåŸç†

### å¯åŠ¨æµç¨‹

```mermaid
graph LR
    A[å®¹å™¨å¯åŠ¨] --> B[æ‰§è¡Œ start.sh]
    B --> C[è¿è¡Œ migrate.ts]
    C --> D{æ•°æ®åº“å¯è¾¾?}
    D -->|æ˜¯| E[æ£€æŸ¥è¿ç§»çŠ¶æ€]
    D -->|å¦| F[å¯åŠ¨å¤±è´¥]
    E --> G{æœ‰æ–°è¿ç§»?}
    G -->|æ˜¯| H[æ‰§è¡Œ SQL]
    G -->|å¦| I[è·³è¿‡]
    H --> J[å¯åŠ¨åº”ç”¨]
    I --> J
```

### å…³é”®æ–‡ä»¶

**1. `backend/src/migrate.ts`** - è¿ç§»è„šæœ¬
```typescript
// ä½¿ç”¨ drizzle-orm çš„åŸç”Ÿ migrate API
// ä¸ä¾èµ– drizzle-kitï¼ˆå¼€å‘ä¾èµ–ï¼‰
await migrate(db, { migrationsFolder: './drizzle' })
```

**2. `backend/start.sh`** - å®¹å™¨å¯åŠ¨è„šæœ¬
```bash
bun run src/migrate.ts  # å…ˆè¿ç§»
exec bun run dist/index.js  # åå¯åŠ¨
```

**3. `backend/drizzle/`** - è¿ç§»æ–‡ä»¶ç›®å½•
- `0000_xxx.sql` - SQL è¿ç§»æ–‡ä»¶
- `meta/_journal.json` - è¿ç§»ç‰ˆæœ¬è®°å½•

## æ€§èƒ½å½±å“

### æµ‹è¯•ç»“æœ

| åœºæ™¯ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| **æ— æ–°è¿ç§»ï¼ˆå¸¸è§ï¼‰** | ~100-200ms | åªæŸ¥è¯¢æ£€æŸ¥ï¼Œå¿«é€Ÿè·³è¿‡ |
| **æœ‰æ–°è¿ç§»** | ~2-5s | å–å†³äº SQL å¤æ‚åº¦ |
| **æ•°æ®åº“ä¸å¯è¾¾** | ~3s | è¿æ¥è¶…æ—¶åå¤±è´¥ |

### å®é™…å½±å“

```
ğŸ—„ï¸  Running database migrations...     â† è¿ç§»å¼€å§‹
âœ… Migrations completed successfully    â† ~150ms åå®Œæˆ
ğŸš€ Starting application...              â† åº”ç”¨å¯åŠ¨
```

**ç»“è®ºï¼šå¯¹å¯åŠ¨æ—¶é—´å½±å“æå°ï¼ˆ< 200msï¼‰ï¼Œå¯å¿½ç•¥ä¸è®¡ã€‚**

## å¹‚ç­‰æ€§ä¿è¯

### Drizzle çš„è¿ç§»æœºåˆ¶

1. åœ¨æ•°æ®åº“ä¸­åˆ›å»º `__drizzle_migrations` è¡¨
2. è®°å½•æ¯ä¸ªå·²æ‰§è¡Œçš„è¿ç§»æ–‡ä»¶å“ˆå¸Œ
3. æ¯æ¬¡å¯åŠ¨æ£€æŸ¥å“ªäº›è¿ç§»æœªæ‰§è¡Œ
4. åªæ‰§è¡Œæ–°çš„è¿ç§»

### éªŒè¯å¹‚ç­‰æ€§

```bash
# é‡å¯å®¹å™¨ 10 æ¬¡
for i in {1..10}; do
    docker restart fullstack-backend
    sleep 3
done

# æŸ¥çœ‹æ—¥å¿— - æ¯æ¬¡éƒ½ä¼šçœ‹åˆ° "Migrations completed successfully"
docker logs fullstack-backend
```

**âœ… å¤šæ¬¡è¿è¡Œç»“æœå®Œå…¨ä¸€è‡´ï¼Œä¸ä¼šé‡å¤æ‰§è¡Œå·²æœ‰è¿ç§»ã€‚**

## å¹¶å‘å®‰å…¨

### å¤šå®ä¾‹åœºæ™¯

å¦‚æœåŒæ—¶å¯åŠ¨å¤šä¸ªåç«¯å®¹å™¨ï¼ˆå¦‚ Kubernetes æ°´å¹³æ‰©å±•ï¼‰ï¼š

1. **ç¬¬ä¸€ä¸ªå®¹å™¨**ï¼šè·å¾—æ•°æ®åº“é”ï¼Œæ‰§è¡Œè¿ç§»
2. **å…¶ä»–å®¹å™¨**ï¼šç­‰å¾…é”é‡Šæ”¾ï¼Œæ£€æŸ¥å‘ç°å·²å®Œæˆï¼Œè·³è¿‡
3. **æ‰€æœ‰å®¹å™¨**ï¼šæ­£å¸¸å¯åŠ¨åº”ç”¨

Drizzle ä½¿ç”¨ PostgreSQL çš„äº‹åŠ¡é”ä¿è¯å¹¶å‘å®‰å…¨ã€‚

## æ•…éšœå¤„ç†

### è¿ç§»å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

å¦‚æœè¿ç§»è„šæœ¬å‡ºé”™ï¼š

```bash
âŒ Migration failed: ...error details...
```

**å®¹å™¨ä¼šç«‹å³é€€å‡ºï¼ˆexit 1ï¼‰**ï¼Œåº”ç”¨ä¸ä¼šå¯åŠ¨ã€‚

**è¿™æ˜¯è®¾è®¡è¡Œä¸º - Fail Fast åŸåˆ™ï¼š**
- âœ… é˜²æ­¢åº”ç”¨åœ¨æ•°æ®åº“ç»“æ„ä¸ä¸€è‡´æ—¶å¯åŠ¨
- âœ… å¼ºåˆ¶å¼€å‘è€…ç«‹å³ä¿®å¤è¿ç§»é—®é¢˜
- âœ… é¿å…ç”Ÿäº§ç¯å¢ƒæ•°æ®æŸå

### ä¿®å¤æ­¥éª¤

1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—å®šä½é”™è¯¯
   ```bash
   docker logs fullstack-backend
   ```

2. ä¿®å¤è¿ç§»æ–‡ä»¶æˆ–æ•°æ®åº“é—®é¢˜

3. é‡æ–°ç”Ÿæˆè¿ç§»ï¼ˆå¦‚éœ€è¦ï¼‰
   ```bash
   cd backend
   bun run db:generate
   ```

4. é‡å¯å®¹å™¨
   ```bash
   docker compose -f docker/docker-compose.yml restart backend
   ```

## å¼€å‘å·¥ä½œæµ

### æ·»åŠ æ–°å­—æ®µçš„å®Œæ•´æµç¨‹

```bash
# 1. ä¿®æ”¹ schema
cd backend
vi src/db/schema.ts

# 2. ç”Ÿæˆè¿ç§»
bun run db:generate

# 3. æœ¬åœ°æµ‹è¯•è¿ç§»
bun run db:migrate

# 4. æäº¤ä»£ç ï¼ˆåŒ…å«è¿ç§»æ–‡ä»¶ï¼‰
git add src/db/schema.ts drizzle/
git commit -m "ã€ADDã€‘ç”¨æˆ·è¡¨æ–°å¢å¤´åƒå­—æ®µ"

# 5. éƒ¨ç½² - è¿ç§»è‡ªåŠ¨æ‰§è¡Œ
docker compose up -d --build
```

## ç¦ç”¨è‡ªåŠ¨è¿ç§»

å¦‚æœä½ éœ€è¦æ‰‹åŠ¨æ§åˆ¶è¿ç§»æ—¶æœºï¼ˆä¸æ¨èï¼‰ï¼š

**ä¿®æ”¹ `backend/start.sh`ï¼š**
```bash
#!/bin/sh
set -e

# æ³¨é‡Šæ‰è‡ªåŠ¨è¿ç§»
# bun run src/migrate.ts

echo "ğŸš€ Starting application..."
exec bun run dist/index.js
```

**ç„¶åæ‰‹åŠ¨æ‰§è¡Œè¿ç§»ï¼š**
```bash
docker exec fullstack-backend bun run src/migrate.ts
```

## æœ€ä½³å®è·µ

### âœ… æ¨è

1. **å‘åå…¼å®¹çš„è¿ç§»**
   - æ–°å¢å­—æ®µè®¾ç½®é»˜è®¤å€¼æˆ–å…è®¸ NULL
   - å…ˆæ·»åŠ å­—æ®µï¼Œååˆ é™¤æ—§å­—æ®µï¼ˆä¸¤æ­¥è¿ç§»ï¼‰

2. **å°æ­¥å¿«è·‘**
   - æ¯æ¬¡è¿ç§»åªåšä¸€ä¸ªæ”¹åŠ¨
   - é¿å…å¤§è§„æ¨¡æ•°æ®è¿ç§»ï¼ˆä½¿ç”¨æ‰¹å¤„ç†è„šæœ¬ï¼‰

3. **æµ‹è¯•è¿ç§»**
   - åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•åå†éƒ¨ç½²
   - ä½¿ç”¨ç”Ÿäº§æ•°æ®çš„å‰¯æœ¬æµ‹è¯•

### âŒ é¿å…

1. **ç ´åæ€§è¿ç§»**
   ```sql
   -- ä¸è¦ç›´æ¥åˆ é™¤åˆ—ï¼ˆæ—§ä»£ç è¿˜åœ¨ä½¿ç”¨ï¼‰
   ALTER TABLE users DROP COLUMN old_field;
   
   -- åº”è¯¥åˆ†ä¸¤æ­¥ï¼š
   -- Step 1: åœæ­¢ä½¿ç”¨ old_fieldï¼ˆéƒ¨ç½²æ–°ä»£ç ï¼‰
   -- Step 2: åˆ é™¤ old_fieldï¼ˆå†æ¬¡éƒ¨ç½²ï¼‰
   ```

2. **ä¾èµ–å¤–éƒ¨èµ„æº**
   ```typescript
   // ä¸è¦åœ¨è¿ç§»ä¸­è°ƒç”¨å¤–éƒ¨ API
   await fetch('https://api.example.com/data')
   ```

3. **é•¿æ—¶é—´è¿è¡Œçš„è¿ç§»**
   - æ•°ç™¾ä¸‡è¡Œæ•°æ®è¿ç§»ä¼šé˜»å¡å¯åŠ¨
   - åº”è¯¥ç”¨ç‹¬ç«‹çš„æ‰¹å¤„ç†è„šæœ¬

## ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹è¿ç§»å†å²

```sql
-- è¿æ¥æ•°æ®åº“
docker exec -it fullstack-postgres psql -U postgres -d fullstack_db

-- æŸ¥çœ‹è¿ç§»è®°å½•
SELECT * FROM drizzle.__drizzle_migrations;
```

### è¾“å‡ºç¤ºä¾‹

```
 id | hash                              | created_at
----+-----------------------------------+-------------------------
  1 | 0000_cold_tinkerer                | 2025-12-13 15:36:30.123
```

## å¸¸è§é—®é¢˜

### Q: æ¯æ¬¡é‡å¯éƒ½ä¼šæ‰§è¡Œè¿ç§»ï¼Œå½±å“æ€§èƒ½å—ï¼Ÿ

A: **ä¸ä¼š**ã€‚å·²æ‰§è¡Œçš„è¿ç§»åªéœ€ 100-200ms æ£€æŸ¥æ—¶é—´ï¼Œå¯¹å¯åŠ¨å‡ ä¹æ— å½±å“ã€‚

### Q: å¤šä¸ªå®¹å™¨åŒæ—¶å¯åŠ¨ä¼šå†²çªå—ï¼Ÿ

A: **ä¸ä¼š**ã€‚Drizzle ä½¿ç”¨æ•°æ®åº“é”ä¿è¯åªæœ‰ä¸€ä¸ªå®¹å™¨æ‰§è¡Œè¿ç§»ã€‚

### Q: å¦‚ä½•å›æ»šè¿ç§»ï¼Ÿ

A: Drizzle ä¸æ”¯æŒè‡ªåŠ¨å›æ»šã€‚éœ€è¦æ‰‹åŠ¨ç¼–å†™åå‘è¿ç§»ï¼š
```bash
# ç”Ÿæˆæ–°çš„è¿ç§»æ¥æ’¤é”€ä¹‹å‰çš„æ”¹åŠ¨
bun run db:generate
```

### Q: è¿ç§»å¤±è´¥ä¼šå¯¼è‡´æ•°æ®æŸåå—ï¼Ÿ

A: **ä¸ä¼š**ã€‚è¿ç§»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¤±è´¥ä¼šè‡ªåŠ¨å›æ»šã€‚

---

## æ€»ç»“

**è‡ªåŠ¨è¿ç§» = é›¶è¿ç»´ + é›¶å‡ºé”™**

- âœ… å®¹å™¨å¯åŠ¨è‡ªåŠ¨è¿ç§»
- âœ… å¹‚ç­‰å®‰å…¨ï¼Œå¯é‡å¤è¿è¡Œ
- âœ… å¹¶å‘å®‰å…¨ï¼Œæ”¯æŒå¤šå®ä¾‹
- âœ… Fail Fastï¼Œé˜²æ­¢æ•°æ®ä¸ä¸€è‡´
- âœ… æ€§èƒ½å½±å“å¯å¿½ç•¥ï¼ˆ< 200msï¼‰

**"Talk is cheap. Show me the code."** - è‡ªåŠ¨è¿ç§»è®©éƒ¨ç½²æ›´ç®€å•ï¼Œè®©é”™è¯¯æ›´æ—©æš´éœ²ã€‚

