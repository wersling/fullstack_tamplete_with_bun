name: Docker Image CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      # GitHub Container Registry
      GHCR_BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/fullstack-backend
      GHCR_FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/fullstack-frontend
      # é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“ï¼ˆä¸ªäººç‰ˆå®ä¾‹åœ°å€ï¼‰
      ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
      ALIYUN_BACKEND_IMAGE: ${{ secrets.ALIYUN_REGISTRY }}/fullstack-backend
      ALIYUN_FRONTEND_IMAGE: ${{ secrets.ALIYUN_REGISTRY }}/fullstack-frontend
      # ç‰ˆæœ¬å·ï¼šä½¿ç”¨ run ç¼–å·ä½œä¸º tagï¼Œç¨³å®šã€å”¯ä¸€
      VERSION: ${{ github.run_number }}

    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” ç™»å½• GitHub Container Registry
        if: github.event_name != 'pull_request'
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: ğŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“
        if: github.event_name != 'pull_request'
        run: echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login ${{ secrets.ALIYUN_REGISTRY }} -u ${{ secrets.ALIYUN_REGISTRY_USERNAME }} --password-stdin

      # ==================== æ„å»ºåç«¯é•œåƒ ====================
      - name: ğŸ—ï¸ æ„å»ºåç«¯ Docker é•œåƒ
        run: |
          docker build --platform linux/amd64 \
            -t $GHCR_BACKEND_IMAGE:$VERSION \
            -t $GHCR_BACKEND_IMAGE:latest \
            -f docker/Dockerfile.backend .

      - name: ğŸ·ï¸ ä¸ºåç«¯é•œåƒæ·»åŠ é˜¿é‡Œäº‘æ ‡ç­¾
        if: github.event_name != 'pull_request'
        run: |
          docker tag $GHCR_BACKEND_IMAGE:$VERSION $ALIYUN_BACKEND_IMAGE:$VERSION
          docker tag $GHCR_BACKEND_IMAGE:latest $ALIYUN_BACKEND_IMAGE:latest

      - name: ğŸ“¤ æ¨é€åç«¯é•œåƒåˆ° GitHub Container Registry
        if: github.event_name != 'pull_request'
        run: |
          docker push $GHCR_BACKEND_IMAGE:$VERSION
          docker push $GHCR_BACKEND_IMAGE:latest

      - name: ğŸ“¤ æ¨é€åç«¯é•œåƒåˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“
        if: github.event_name != 'pull_request'
        run: |
          docker push $ALIYUN_BACKEND_IMAGE:$VERSION
          docker push $ALIYUN_BACKEND_IMAGE:latest

      # ==================== æ„å»ºå‰ç«¯é•œåƒ ====================
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯ Docker é•œåƒ
        run: |
          docker build --platform linux/amd64 \
            -t $GHCR_FRONTEND_IMAGE:$VERSION \
            -t $GHCR_FRONTEND_IMAGE:latest \
            -f docker/Dockerfile.frontend .

      - name: ğŸ·ï¸ ä¸ºå‰ç«¯é•œåƒæ·»åŠ é˜¿é‡Œäº‘æ ‡ç­¾
        if: github.event_name != 'pull_request'
        run: |
          docker tag $GHCR_FRONTEND_IMAGE:$VERSION $ALIYUN_FRONTEND_IMAGE:$VERSION
          docker tag $GHCR_FRONTEND_IMAGE:latest $ALIYUN_FRONTEND_IMAGE:latest

      - name: ğŸ“¤ æ¨é€å‰ç«¯é•œåƒåˆ° GitHub Container Registry
        if: github.event_name != 'pull_request'
        run: |
          docker push $GHCR_FRONTEND_IMAGE:$VERSION
          docker push $GHCR_FRONTEND_IMAGE:latest

      - name: ğŸ“¤ æ¨é€å‰ç«¯é•œåƒåˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒä»“åº“
        if: github.event_name != 'pull_request'
        run: |
          docker push $ALIYUN_FRONTEND_IMAGE:$VERSION
          docker push $ALIYUN_FRONTEND_IMAGE:latest

      - name: âœ… é•œåƒæ„å»ºå’Œæ¨é€å®Œæˆ
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ‰ Docker é•œåƒæ„å»ºå’Œæ¨é€æˆåŠŸï¼"
          echo ""
          echo "ğŸ“¦ åç«¯é•œåƒï¼š"
          echo "  - GHCR: $GHCR_BACKEND_IMAGE:$VERSION"
          echo "  - é˜¿é‡Œäº‘: $ALIYUN_BACKEND_IMAGE:$VERSION"
          echo ""
          echo "ğŸ“¦ å‰ç«¯é•œåƒï¼š"
          echo "  - GHCR: $GHCR_FRONTEND_IMAGE:$VERSION"
          echo "  - é˜¿é‡Œäº‘: $ALIYUN_FRONTEND_IMAGE:$VERSION"

